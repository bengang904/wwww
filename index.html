<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>wwwwww.2024-10-24.zip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/7.css">
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: linear-gradient(#2b6cb0, #1c4878);
      font-family: "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    iframe { position: fixed; top:0; left:0; width:100%; height:100%; border:none; z-index:0; }
    .dialog-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:9999; }
    #launcher .window-body, #dialog .window-body { padding:16px 22px; }
    #launcher p, #dialog p { margin-bottom: 12px; }
    .window { box-shadow:0 6px 16px rgba(0,0,0,0.3); border-radius:4px; width: fit-content; max-width: 80vw; }
    @keyframes fadeIn { from {opacity:0; transform:scale(0.95);} to {opacity:1; transform:scale(1);} }
    #dialog .window { animation: fadeIn 0.25s ease-out; }
    #launcher { width: 400px; max-width:80vw; }
    #inputUrl, #inputTitle, #inputIcon, #defaultBehavior { width:100%; box-sizing:border-box; padding:6px 8px; margin-bottom: 8px; }
    #dialog .window { width:340px; max-width:80vw; }
  </style>
</head>
<body class="win7">

<div id="launcher" class="window active">
  <div class="title-bar"><div class="title-bar-text">https://wwww.2024-10-24.zip</div></div>
  <div class="window-body">
    <p>请输入要加密访问的 URL：</p>
    <input type="url" id="inputUrl" placeholder="例如：2024-10-24.zip" required>
    <input type="text" id="inputTitle" placeholder="标签页标题 (可选)">
    <input type="url" id="inputIcon" placeholder="标签页图标 URL (可选)">
    <p>默认行为：</p>
    <select id="defaultBehavior">
      <option value="prompt" selected>显示外部链接提示</option>
      <option value="auto">自动打开链接（跳过提示）</option>
    </select>
    <section class="field-row" style="justify-content:flex-end;">
      <button id="encryptBtn">加密链接</button>
    </section>
  </div>
</div>

<div id="dialog" class="dialog-overlay" style="display:none;">
  <div class="window">
    <div class="title-bar"><div class="title-bar-text">外部链接提示</div></div>
    <div class="window-body">
      <p>检测到解密后链接：<br><span id="urlText" style="color:#0645AD;"></span></p>
      <p>确定要在此页面内显示吗？</p>
      <section class="field-row" style="justify-content:flex-end;">
        <button id="confirmBtn">确定</button>
        <button id="cancelBtn">取消</button>
      </section>
    </div>
  </div>
</div>

<iframe id="viewer" style="display:none;"></iframe>

<script>
const SECRET_KEY="wwww.2024-10-24.zip";
const DEFAULT_ICON="https://2024-10-24.zip/images/wwww.jpg";

function encrypt(text){ return encodeURIComponent(CryptoJS.AES.encrypt(text,SECRET_KEY).toString()); }
function decrypt(text){ try{ return CryptoJS.AES.decrypt(decodeURIComponent(text),SECRET_KEY).toString(CryptoJS.enc.Utf8)||null;}catch(e){return null;} }

function updateFavicon(icon){
  const rels=["shortcut icon","icon","apple-touch-icon-precomposed"];
  rels.forEach(r=>{
    let link=document.querySelector(`link[rel='${r}']`)||document.createElement('link');
    link.rel=r;
    link.href=icon;
    document.head.appendChild(link);
  });
  let meta=document.querySelector("meta[name='msapplication-TileImage']")||document.createElement('meta');
  meta.name="msapplication-TileImage";
  meta.content=icon;
  document.head.appendChild(meta);
}

function ensureProtocol(url){
  if(/^https?:\/\//i.test(url)) return url;
  return "https://" + url;
}

const params = new URLSearchParams(window.location.search);
const data = params.get('data');
const viewer = document.getElementById('viewer');
const dialog = document.getElementById('dialog');
const urlText = document.getElementById('urlText');
const launcher = document.getElementById('launcher');
const behaviorSelect = document.getElementById('defaultBehavior');
let url=null, title=null, icon=null;

behaviorSelect.value = localStorage.getItem('defaultBehavior') || 'prompt';
behaviorSelect.addEventListener('change', ()=>{
  localStorage.setItem('defaultBehavior', behaviorSelect.value);
});

if(data){
  try{
    const decrypted = JSON.parse(decrypt(data));
    url = decrypted.url ? ensureProtocol(decrypted.url) : null;
    title = decrypted.title || null;
    icon = decrypted.icon || DEFAULT_ICON;
    if(title) document.title=title;
    if(icon) updateFavicon(icon);

    if(url){
      launcher.style.display='none';
      const defaultBehavior = localStorage.getItem('defaultBehavior') || 'prompt';
      if(defaultBehavior === 'auto'){
        viewer.src = url;
        viewer.style.display='block';
        document.body.style.background='none';
      }else{
        dialog.style.display='flex';
        urlText.textContent = url;
      }
    }else{ alert("无法解密链接"); }
  }catch(e){ alert("无法解密链接"); }
}else{
  updateFavicon(DEFAULT_ICON);
}

document.getElementById('confirmBtn').addEventListener('click',()=>{
  dialog.style.display='none';
  viewer.src=url;
  viewer.style.display='block';
  document.body.style.background='none';
});
document.getElementById('cancelBtn').addEventListener('click',()=>{
  window.open(url,'_blank');
  dialog.style.display='none';
});

document.getElementById('encryptBtn').addEventListener('click', e=>{
  e.preventDefault();
  let inputUrl=document.getElementById('inputUrl').value.trim();
  inputUrl = ensureProtocol(inputUrl);
  const inputTitle=document.getElementById('inputTitle').value.trim();
  const inputIcon=document.getElementById('inputIcon').value.trim() || DEFAULT_ICON;
  if(inputUrl){
    const payload={url:inputUrl,title:inputTitle,icon:inputIcon};
    const encrypted=encrypt(JSON.stringify(payload));
    const newUrl=`${window.location.pathname}?data=${encrypted}`;
    navigator.clipboard.writeText(window.location.origin+newUrl).then(()=>{
      alert("加密链接已复制到剪贴板！");
      window.location.href=newUrl;
    }).catch(()=>{
      window.location.href=newUrl;
    });
  }
});
</script>
</body>
</html>
